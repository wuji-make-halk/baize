<?php
namespace Publics\Controller;
use Think\Controller;
class WechatDataController extends Controller {
    public $channel=array(
        //星大陆[神奇精灵球]
        'Uj0O5527nKRG0A9q'=>array(
            'product'=>'wxd5c814262e2adf8c',
            'channel'=>array('allu','XDLxxjlq0001','XDLxxjlq0002'),
            'cps_type'=>'1'
        ),
        //雨墨[小小精灵球]
        'y8ZzS0lo'=>array(
            'product'=>'wx49cda2492f8feedb',
            'channel'=>array('YMxxjlq0001','YMxxjlq0002','YMxxjlq0003','YMxxjlq0004','YMxxjlq0005','YMxxjlq0006','YMxxjlq0007','YMxxjlq0008','YMxxjlq0009','YMxxjlq0010','YMxxjlq0011','YMxxjlq0012','YMxxjlq0013','YMxxjlq0014','YMxxjlq0015','YMxxjlq0016','YMxxjlq0017','YMxxjlq0018','YMxxjlq0019','YMxxjlq0020'),
            'cps_type'=>'2'
        ),
        //雨墨[御剑青云决]
        'uK8a2XGQbDD8ei9C'=>array(
            'product'=>'wx0d85ccf6e166b152',
            'channel'=>array('YMyjqyj0001','YMyjqyj0002','YMyjqyj0003','YMyjqyj0004','YMyjqyj0005','YMyjqyj0006','YMyjqyj0007','YMyjqyj0008','YMyjqyj0009','YMyjqyj0010','YMyjqyj0011','YMyjqyj0012','YMyjqyj0013','YMyjqyj0014','YMyjqyj0015','YMyjqyj0016','YMyjqyj0017','YMyjqyj0018','YMyjqyj0019','YMyjqyj0020'),
            'cps_type'=>'2'
        ),
        //雨墨[太古仙穹]
        'IWpQ1yYBnf6A81mv'=>array(
            'product'=>'wx576cd9788a2a9c91',
            'channel'=>array('YMtgxq0001','YMtgxq0002','YMtgxq0003','YMtgxq0004','YMtgxq0005','YMtgxq0006','YMtgxq0007','YMtgxq0008','YMtgxq0009','YMtgxq0010','YMtgxq0011','YMtgxq0012','YMtgxq0013','YMtgxq0014','YMtgxq0015','YMtgxq0016','YMtgxq0017','YMtgxq0018','YMtgxq0019','YMtgxq0020'),
            'cps_type'=>'2'
        ),
        //雨墨[梦幻神兵]
        'H5oX0vbdyDz01Mli'=>array(
            'product'=>'wx93622ae9f4eac32c',
            'channel'=>array('YMmhsb0001','YMmhsb0002','YMmhsb0003','YMmhsb0004','YMmhsb0005','YMmhsb0006','YMmhsb0007','YMmhsb0008','YMmhsb0009','YMmhsb0010','YMmhsb0011','YMmhsb0012','YMmhsb0013','YMmhsb0014','YMmhsb0015','YMmhsb0016','YMmhsb0017','YMmhsb0018','YMmhsb0019','YMmhsb0020'),
            'cps_type'=>'2'
        ),
        //雨墨[无双群英传]
        'ypdI4dbOI23olfbg'=>array(
            'product'=>'wx0b59618311028aca',
            'channel'=>array('YMwsqyz0001','YMwsqyz0002','YMwsqyz0003','YMwsqyz0004','YMwsqyz0005','YMwsqyz0006','YMwsqyz0007','YMwsqyz0008','YMwsqyz0009','YMwsqyz0010','YMwsqyz0011','YMwsqyz0012','YMwsqyz0013','YMwsqyz0014','YMwsqyz0015','YMwsqyz0016','YMwsqyz0017','YMwsqyz0018','YMwsqyz0019','YMwsqyz0020'),
            'cps_type'=>'2'
        ),
        //雨墨[青云神剑]
        '5Jc2OcCdNgKlA9DS'=>array(
            'product'=>'wx1e736935ed9c9ba3',
            'channel'=>array('YMqysj0001','YMqysj0002','YMqysj0003','YMqysj0004','YMqysj0005','YMqysj0006','YMqysj0007','YMqysj0008','YMqysj0009','YMqysj0010','YMqysj0011','YMqysj0012','YMqysj0013','YMqysj0014','YMqysj0015','YMqysj0016','YMqysj0017','YMqysj0018','YMqysj0019','YMqysj0020'),
            'cps_type'=>'2'
        ),
        //雨墨[凡人升仙传]
        '50aGsjWcHuokdDw7'=>array(
            'product'=>'wx95e08b66eca6c2d5',
            'channel'=>array('YM-frsxz0001','YM-frsxz0002','YM-frsxz0003','YM-frsxz0004','YM-frsxz0005','YM-frsxz0006','YM-frsxz0007','YM-frsxz0008','YM-frsxz0009','YM-frsxz0010','YM-frsxz0011','YM-frsxz0012','YM-frsxz0013','YM-frsxz0014','YM-frsxz0015','YM-frsxz0016','YM-frsxz0017','YM-frsxz0018','YM-frsxz0019','YM-frsxz0020'),
            'cps_type'=>'2'
        ),
        //星大陆[无双群英传]
        'U154esjmZ3gI4L8Z'=>array(
            'product'=>'wx0b59618311028aca',
            'channel'=>array('XDLwsqyz0001','XDLwsqyz0002','XDLwsqyz0003','XDLwsqyz0004','XDLwsqyz0005'),
            'cps_type'=>'1'
        ),
        //至劲[小小精灵球]
        'IEoZIx5a8EYhtjXb'=>array(
            'product'=>'wx49cda2492f8feedb',
            'channel'=>array('ZJxxjlq0001',),
            'cps_type'=>'3'
        )
        
    );
    public function base_data(){
        
        if($_GET['start_time']&&$_GET['channel']){
            if(!array_key_exists($_GET['channel'],$this->channel)){
                exit(self::error('非法访问'));
            }
            
            $product=$this->channel[$_GET['cps']!=''?$_GET['cps']:$_GET['channel']]['product'];
            $channel=$this->channel[$_GET['cps']!=''?$_GET['cps']:$_GET['channel']]['channel'];
            
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);
           
            foreach (array_fill(0,($date+1),$channel) as $k=>$v){
                foreach ($v as $vv){
                    $page_where[]=array(
                        'channel'=>$vv,
                        'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$k.'day')),
                        'product'=>$product
                    );
                }
            }
                
            $count      = count($page_where);// 查询满足要求的总记录数
           
           
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里
            
//             $data=array();
            $data=self::base_data_core($page_where);
            $data_sum=self::base_data_sum($data);
            
            
            
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            
            //print_r($comma_separated);EXIT;
//             for ($i=$Page->firstRow;$i<$Page->firstRow+$Page->listRows;$i++){
//                 if($Page->totalRows<=$i){
//                     break;
//                 }
                
               
//             }
            
            self::assign('page',$page_show);
            self::assign('data',$data);
        }
        
        $product_list=M('mini_programs','','DB_CONFIG1')->where(array('mini_id'=>array('neq',2)))->cache(500)->getField('mini_appid,mini_name');
        $cpsList = M('mini_cps','','DB_CONFIG1')->where(array('cps_type'=>$this->channel[$_GET['channel']]['cps_type']))->cache(500)->select();
        foreach ($cpsList as $key => $value) {
            $cps[$value['channel']] .= $value['game_name'];
        }
        self::assign('cps',$cps);
        self::assign('product_list',$product_list);
        self::display();
    }

    public function wechat_game(){
        if($_GET['start_time']&&$_GET['cps']&&$_GET['game_cps']){
           
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);
           
            foreach (array_fill(0,($date+1),$_GET['game_cps']) as $k=>$v){
                foreach ($v as $vv){
                    $page_where[]=array(
                        'channel'=>$vv,
                        'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$k.'day')),
                        'product'=>$_GET['cps']
                    );
                }
            }
                
            $count      = count($page_where);// 查询满足要求的总记录数
           
           
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里
            
            $data=self::base_data_core($page_where);
            $data_sum=self::base_data_sum($data);
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            
            self::assign('page',$page_show);
            self::assign('data',$data);
        }

        $product_list=M('mini_programs','','DB_CONFIG1')->where(array('mini_id'=>array('neq',2)))->cache(500)->getField('mini_appid,mini_name');
        $cpsList = M('mini_cps','','DB_CONFIG1')->where(array('cps_name'=>$_GET['cps_code']))->cache(500)->select();
        foreach ($cpsList as $key => $value) {
            $cps[$value['appid']] .= $value['game_name'];
        }
        self::assign('cps',$cps);
        self::assign('product_list',$product_list);
        self::display();
    }

    public function new_base_data(){
        
        if($_GET['start_time']&&$_GET['channel']){
            if(!array_key_exists($_GET['channel'],$this->channel)){
                exit(self::error('非法访问'));
            }
            
            $product=$this->channel[$_GET['cps']!=''?$_GET['cps']:$_GET['channel']]['product'];
            $channel=$this->channel[$_GET['cps']!=''?$_GET['cps']:$_GET['channel']]['channel'];
            
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);
           
            foreach (array_fill(0,($date+1),$channel) as $k=>$v){
                foreach ($v as $vv){
                    $page_where[]=array(
                        'channel'=>$vv,
                        'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$k.'day')),
                        'product'=>$product
                    );
                }
            }
                
            $count      = count($page_where);// 查询满足要求的总记录数
           
           
            $Page       = new \Think\Page($count);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里
            
//             $data=array();
            $data=self::new_base_data_core($page_where);
            $data_sum=self::new_base_data_sum($data);
            
            
            
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            
            //print_r($comma_separated);EXIT;
//             for ($i=$Page->firstRow;$i<$Page->firstRow+$Page->listRows;$i++){
//                 if($Page->totalRows<=$i){
//                     break;
//                 }
                
               
//             }
            
            self::assign('page',$page_show);
            self::assign('data',$data);
        }
        
        $product_list=M('mini_programs','','DB_CONFIG1')->where(array('mini_id'=>array('neq',2)))->cache(500)->getField('mini_appid,mini_name');
        $cpsList = M('mini_cps','','DB_CONFIG1')->where(array('cps_type'=>$this->channel[$_GET['channel']]['cps_type']))->cache(500)->select();
        foreach ($cpsList as $key => $value) {
            $cps[$value['channel']] .= $value['game_name'];
        }
        self::assign('cps',$cps);
        self::assign('product_list',$product_list);
        self::display();
    }

    private  function base_data_core($parma){
        $data=array();
        foreach ($parma as $v){
            $parmas=array('start_time'=>$v['start_time'],
                'product'=>$v['product'],
                'channel'=>$v['channel']
            );
            $DATA=self::combination_data($parmas);
            $DATA['time']=$parmas['start_time'];
            $DATA['channel_code'] = $parmas['channel'];
            $data[]=$DATA;
        }
        return $data;
    }

    private  function new_base_data_core($parma){
        $data=array();
        foreach ($parma as $v){
            $parmas=array('start_time'=>$v['start_time'],
                'product'=>$v['product'],
                'channel'=>$v['channel']
            );
            $DATA=self::new_combination_data($parmas);
            $DATA['time']=$parmas['start_time'];
            $data[]=$DATA;
        }
        return $data;
    }

    private function  base_data_sum($parma){
        
        $data= array(
            'time'=>'汇总',
            '渠道'=>'-',
            'product'=>'-',
            '新增注册'=>array_sum(array_column($parma, '新增注册')),
            '新增创角'=>array_sum(array_column($parma, '新增创角')),
            '总登陆用户'=>array_sum(array_column($parma, '总登陆用户')),
            '老用户登陆'=>array_sum(array_column($parma, '老用户登陆')),
            '新用户付费金额'=>array_sum(array_column($parma, '新用户付费金额')),
            '老用户付费金额'=>array_sum(array_column($parma, '老用户付费金额')),
            '老用户付费人数'=>array_sum(array_column($parma, '老用户付费人数')),
            '新增付费人数'=>array_sum(array_column($parma, '新增付费人数')),
            '总付费人数'=>array_sum(array_column($parma, '总付费人数')),
            '总付费金额'=>array_sum(array_column($parma, '总付费金额')),
            );
        $data['创角转化率']=round(($data['新增创角']/$data['新增注册'])*100,2).'%';
        $data['新增付费率']=round(($data['新增付费人数']/$data['新增注册'])*100,2).'%';
        $data['新增arppu']=round(($data['新用户付费金额']/$data['新增付费人数']),2);
        $data['老用户付费率']=round(($data['老用户付费人数']/$data['老用户登陆'])*100,2).'%';
        $data['老用户arppu']=round(($data['老用户付费金额']/$data['老用户付费人数']),2);
        $data['总付费率']=round(($data['总付费人数']/$data['总登陆用户'])*100,2).'%';
        $data['总arpu']=round(($data['总付费金额']/$data['总登陆用户']),2);
        $data['总arppu']=round(($data['总付费金额']/$data['总付费人数']),2);
        $data['ltv1']=round(($data['新用户付费金额']/$data['新增注册']),2);
        return $data;
    }

    private function  new_base_data_sum($parma){
        
        $data= array(
            'time'=>'汇总',
            '渠道'=>'-',
            'product'=>'-',
            '新增注册'=>array_sum(array_column($parma, '新增注册')),
            '总付费人数'=>array_sum(array_column($parma, '总付费人数')),
            '总付费金额'=>array_sum(array_column($parma, '总付费金额')),
            );
        return $data;
    }

    private function  new_combination_data($parmas){
        
        $new_user_count_where=array('appid'=>array('eq',$parmas['product']),
                              'channel'=>array('eq',$parmas['channel']),
                              'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and')
                              );
                
        $new_user_count=M('mini_user','','DB_CONFIG1')
                        ->where($new_user_count_where)
                        ->cache(500)
                        ->count();//新增用户数
         
         $order=M('mini_game_order','','DB_CONFIG1')
            ->where(array(
                'status'=>array('egt',1),
                'mini_appid'=>array('eq',$parmas['product']),
                'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and'),
            ))
            ->cache(500)
            ->field('sum(money)as user_pay,count(DISTINCT user_id) as user_pay_count')
            ->find(); //付费金额,付费人数
    
    
     // 上面方法到时候可模型化
         
            $order['user_pay']=$order['user_pay']/100;
            
            $data=array(
                '渠道'=>$parmas['channel'],
                '新增注册'=>$new_user_count?sprintf("%.0f",$new_user_count):"-",
                '总付费人数'=>$order['user_pay_count']?sprintf("%.0f",$order['user_pay_count']):"-",
                '总付费金额'=>$order['user_pay']?sprintf("%.2f",$order['user_pay']):"-",
            );    
            return $data;   
    }

    private function  combination_data($parmas){
        
        $new_user_count_where=array('appid'=>array('eq',$parmas['product']),
                              'channel'=>array('eq',$parmas['channel']),
                              'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and')
                              );
                
        $new_user_count=M('mini_user','','DB_CONFIG1')
                        ->where($new_user_count_where)
                        ->cache(500)
                        ->count();//新增用户数
        
        $active_user_count=M('mini_login_log','','DB_CONFIG1')
            ->where(array('appid'=>array('eq',$parmas['product']),
                'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and')
                ))
                //->fetchSql()
            ->cache(500)
            ->count('DISTINCT mini_user_id'); //活跃用户数
            
            
         $new_user_role=M('mini_role_report','','DB_CONFIG1')
            ->where(array('appid'=>array('eq',$parmas['product']),
                'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and'),
                'user_id'=>array('exp','in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
            ))
            //->fetchSql()
            ->cache(500)
            ->count('DISTINCT user_id'); //新增创角色数
            
         $old_user_count=M('mini_login_log','','DB_CONFIG1')
            ->where(array('appid'=>array('eq',$parmas['product']),
                'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and'),
                'mini_user_id'=>array('exp','not in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
            ))
            //->fetchSql()
            ->cache(500)
            ->count('DISTINCT mini_user_id'); //老用户登录数
        //订单表的渠道维度，给不给都无所谓，经过测试，准确无误。
       $new_user_order= M('mini_game_order','','DB_CONFIG1')
            ->where(array(
                'status'=>array('egt',1),
                'mini_appid'=>array('eq',$parmas['product']),
//                 'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and'),
                'user_id'=>array('exp','in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
            ))
            //->fetchSql()
            ->cache(500)
            ->field('sum(money)as new_user_pay,count(DISTINCT user_id) as new_user_pay_count')
            ->find(); //新增付费金额，新增付费人数
            
        $old_user_order= M('mini_game_order','','DB_CONFIG1')
            ->where(array(
                'status'=>array('egt',1),
                'mini_appid'=>array('eq',$parmas['product']),
                 'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and'),
                'user_id'=>array('exp','not in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
            ))
            ->cache(500)
            ->field('sum(money)as old_user_pay,count(DISTINCT user_id) as old_user_pay_count')
            ->find(); //老用户付费金额，老用户付费人数
         
         $order=M('mini_game_order','','DB_CONFIG1')
            ->where(array(
                'status'=>array('egt',1),
                'mini_appid'=>array('eq',$parmas['product']),
                'channel'=>array('eq',$parmas['channel']),
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and'),
            ))
            ->cache(500)
            ->field('sum(money)as user_pay,count(DISTINCT user_id) as user_pay_count')
            ->find(); //付费金额,付费人数
    
    
     // 上面方法到时候可模型化
         
            $new_user_order['new_user_pay']=$new_user_order['new_user_pay']/100;
            $old_user_order['old_user_pay']=$old_user_order['old_user_pay']/100;
            $order['user_pay']=$order['user_pay']/100;
            
            $data=array(
                '渠道'=>$parmas['channel'],
                '新增注册'=>$new_user_count?sprintf("%.0f",$new_user_count):"-",
                '新增创角'=>$new_user_role?sprintf("%.0f",$new_user_role):"-",
                '创角转化率'=>$new_user_role/$new_user_count?round(($new_user_role/$new_user_count)*100,2).'%':"-",
                '总登陆用户'=>$active_user_count?sprintf("%.0f",$active_user_count):"-",
                '老用户登陆'=>$old_user_count?sprintf("%.0f",$old_user_count):"-",
                '新增付费率'=>$new_user_order['new_user_pay_count']/$new_user_count?round(($new_user_order['new_user_pay_count']/$new_user_count)*100,2).'%':"-",
                '新增付费人数'=>$new_user_order['new_user_pay_count'],
                '新增arppu'=>$new_user_order['new_user_pay']/$new_user_order['new_user_pay_count']?round($new_user_order['new_user_pay']/$new_user_order['new_user_pay_count'],2):"-",
                '新用户付费金额'=>$new_user_order['new_user_pay']?sprintf("%.2f",$new_user_order['new_user_pay']):"-",
                '老用户付费金额'=>$old_user_order['old_user_pay']?sprintf("%.2f",$old_user_order['old_user_pay']):"-",
                '老用户付费率'=>$old_user_order['old_user_pay_count']/$old_user_count?round(($old_user_order['old_user_pay_count']/$old_user_count)*100,2).'%':"-",
                '老用户付费人数'=>$old_user_order['old_user_pay_count'],
                '老用户arppu'=>$old_user_order['old_user_pay']/$old_user_order['old_user_pay_count']?round($old_user_order['old_user_pay']/$old_user_order['old_user_pay_count'],2):"-",
                '总付费人数'=>$order['user_pay_count']?sprintf("%.0f",$order['user_pay_count']):"-",
                '总付费金额'=>$order['user_pay']?sprintf("%.2f",$order['user_pay']):"-",
                '总付费率'=>$order['user_pay_count']/$active_user_count?round(($order['user_pay_count']/$active_user_count)*100,2).'%':"-",
                '总arpu'=>$order['user_pay']/$active_user_count?round($order['user_pay']/$active_user_count,2):"-",
                '总arppu'=>$order['user_pay']/$order['user_pay_count']?round($order['user_pay']/$order['user_pay_count'],2):"-",
                'ltv1'=>$new_user_order['new_user_pay']/$new_user_count?round($new_user_order['new_user_pay']/$new_user_count,2):"-"
            );    
            return $data;   
    }
    
    public function get_mini_appid_channel(){
        if ($_POST['cps']=='yumo') {
            $code = 'YM';
            $channel_list=M('mini_game_channel','','DB_CONFIG1')->where(array('appid'=>array('eq',$_POST['appid']),'channel'=>array('like',$code.'%')))->group('channel')->cache(500)->getField('channel',true);
        }else{
            $channel_list=M('mini_game_channel','','DB_CONFIG1')->where(array('appid'=>array('eq',$_POST['appid'])))->group('channel')->cache(500)->getField('channel',true);
        }
        self::success($channel_list);
    }
    
    public function retain(){

        if($_GET['start_time']&&$_GET['cps']&&$_GET['game_cps']){
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);

            foreach (array_fill(0,1,$_GET['game_cps']) as $k=>$v){
                foreach ($v as $vv){
                    $channel .= $vv.',';
                }
            }
            $channel = rtrim($channel, ',');
            foreach (array_fill(0,($date+1),$_GET['game_cps']) as $key => $value) {
                $page_where[]=array(
                    'channel'=>$channel,
                    'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$key.'day')),
                    'product'=>$_GET['cps']
                );
            }
            
            $count      = count($page_where);// 查询满足要求的总记录数
            
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里
            
            $data=self::retain_data_core($page_where);
            $time = date('Y-m-d',strtotime($comma_separated[0]));
            $data_sum=self::retain_data_sum($data,$time);
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            self::assign('page',$page_show);
            self::assign('data',$data);
        }
        $product_list=M('mini_programs','','DB_CONFIG1')->where(array('mini_id'=>array('neq',2)))->cache(500)->getField('mini_appid,mini_name');
        $cpsList = M('mini_cps','','DB_CONFIG1')->where(array('cps_name'=>$_GET['cps_code']))->cache(500)->select();
        foreach ($cpsList as $key => $value) {
            $cps[$value['appid']] .= $value['game_name'];
        }
        self::assign('cps',$cps);
        self::assign('product_list',$product_list);
        self::display();
    }

    private  function retain_data_core($parma){
        $data=array();
        foreach ($parma as $v){
            $parmas=array(
                'start_time'=>$v['start_time'],
                'product'=>$v['product'],
                'channel'=>$v['channel']
            );
            $DATA=self::retain_combination_data($parmas);
            $DATA['time']=$parmas['start_time'];
            $channel_name=M('mini_programs','','DB_CONFIG1')->where(array('mini_appid'=>array('eq',$v['product'])))->cache(500)->field('concat(mini_name) as channel_name')->find();
            $DATA['channel_name'] = $channel_name['channel_name'];
            $DATA['channel_code'] = $parmas['channel'];
            $data[]=$DATA;
        }
        return $data;
    }

    private function  retain_data_sum($parma,$time){
        $count = count($parma);
        $data= array(
            'time'=>'汇总均值',
            '渠道'=>'-',
            'product'=>'-',
            '用户数量'=>sprintf("%.2f",array_sum(array_column($parma, '用户数量'))/$count),
        );
        $date=floor((time()-strtotime($time))/86400);
        // print_r($parma);die;
        $name_list = array();
        foreach ($parma as $value) {
            $name_list[] = $value['retain'];
        }
        // $kk=$date;
        for($i=0;$i<$date;$i++){
            $data['retain']['retain'.($i)]=sprintf("%.2f",array_sum(array_column($name_list, 'retain'.$i))/count(array_column($name_list, 'retain'.$i))).'%';
        }
        return $data;
    }

    private function retain_combination_data($parmas){

        $parmas['channel'] = explode(',', $parmas['channel']);
        for ($i=0; $i < count($parmas['channel']); $i++) {  
            $parmas['into'] .= "`channel`='".$parmas['channel'][$i]."' OR ";
        }
        $parmas['_string'] = rtrim($parmas['into'], " OR ");

        $new_user_count_where=array(
            'appid'=>array('eq',$parmas['product']),
            $parmas['_string'],
            'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and')
        );
        $new_user_count=M('mini_user','','DB_CONFIG1')
                ->where($new_user_count_where)
                ->cache(500)
                ->count();//新增用户数
        
        $date=floor((time()-strtotime($parmas['start_time']))/86400);
        $data=array();
        for($i=0;$i<$date;$i++){
           $old_user_count=M('mini_login_log','','DB_CONFIG1')
            ->where(array(
                'appid'=>array('eq',$parmas['product']),
                $parmas['_string'],
                'create_date'=>array(array('egt',strtotime($parmas['start_time'].' +'.$i.' day')),array('lt',strtotime($parmas['start_time'].' +'.($i+1).' day')),'and'),
                'mini_user_id'=>array('exp','in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
            ))
            //->fetchSql()
            ->cache(500)
            ->count('DISTINCT mini_user_id');
            $data['retain']['retain'.($i)]=$old_user_count/$new_user_count?round(($old_user_count/$new_user_count)*100,2).'%':'-';
        }
        $data['用户数量']=$new_user_count;
        return $data;
    }

    
    public function get_ltv(){

        if($_GET['start_time']&&$_GET['cps']&&$_GET['game_cps']){
            
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);

            foreach (array_fill(0,1,$_GET['game_cps']) as $k=>$v){
                foreach ($v as $vv){
                    $channel .= $vv.',';
                }
            }
            $channel = rtrim($channel, ',');
            foreach (array_fill(0,($date+1),$_GET['game_cps']) as $key => $value) {
                $page_where[]=array(
                    'channel'=>$channel,
                    'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$key.'day')),
                    'product'=>$_GET['cps']
                );
            }
            
            $count      = count($page_where);// 查询满足要求的总记录数
            
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里

            $data = self::ltv_data_core($page_where);
            $time = date('Y-m-d',strtotime($comma_separated[0]));
            $data_sum=self::ltv_data_sum($data,$time);
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            self::assign('page',$page_show);
            self::assign('data',$data);
        }
        $product_list=M('mini_programs','','DB_CONFIG1')->where(array('mini_id'=>array('neq',2)))->cache(500)->getField('mini_appid,mini_name');
        $cpsList = M('mini_cps','','DB_CONFIG1')->where(array('cps_name'=>$_GET['cps_code']))->cache(500)->select();
        foreach ($cpsList as $key => $value) {
            $cps[$value['appid']] .= $value['game_name'];
        }
        self::assign('cps',$cps);
        self::assign('product_list',$product_list);
        self::display();
    }

    private  function ltv_data_core($parma){
        $data=array();
        foreach ($parma as $v){
            $parmas=array(
                'start_time'=>$v['start_time'],
                'product'=>$v['product'],
                'channel'=>$v['channel']
            );
            $DATA=self::ltv_combination_data($parmas);
            $DATA['time']=$parmas['start_time'];
            $channel_name=M('mini_programs','','DB_CONFIG1')->where(array('mini_appid'=>array('eq',$v['product'])))->cache(500)->field('concat(mini_name) as channel_name')->find();
            $DATA['channel_name'] = $channel_name['channel_name'];
            $DATA['channel_code'] = $parmas['channel'];
            $data[]=$DATA;
        }
        return $data;
    }
    private function ltv_data_sum($parma,$time){
        $count = count($parma);
        $data= array(
            'time'=>'汇总均值',
            '渠道'=>'-',
            'product'=>'-',
            '新增注册人数'=>sprintf("%.2f",array_sum(array_column($parma, '新增注册人数'))/$count),
            '充值总额'=>sprintf("%.2f",array_sum(array_column($parma, '充值总额'))/$count),
            '新增付费'=>array_sum(array_column($parma, '新增付费')),
        );
        $date=floor((time()-strtotime($time))/86400);
        $name_list = array();
        foreach ($parma as $value) {
            $name_list[] = $value['ltv'];
        }
        // print_r($name_list);die;
        for($i=0;$i<$date;$i++){
            $data['ltv']['ltv'.($i)]=sprintf("%.2f",array_sum(array_column($name_list, 'ltv'.$i))/count(array_column($name_list, 'ltv'.$i)));
        }
        return $data;
    }

    private function ltv_combination_data($parmas){

        $parmas['channel'] = explode(',', $parmas['channel']);
        for ($i=0; $i < count($parmas['channel']); $i++) {  
            $parmas['into'] .= "`channel`='".$parmas['channel'][$i]."' OR ";
        }
        $parmas['_string'] = rtrim($parmas['into'], " OR ");

        $new_user_count_where=array('appid'=>array('eq',$parmas['product']),
            $parmas['_string'],
            'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +1 day')),'and')
        );
        $new_user_count=M('mini_user','','DB_CONFIG1')
        ->where($new_user_count_where)
        ->cache(500)
        ->count();//新增用户数
        
        $sum_new_user_order= M('mini_game_order','','DB_CONFIG1')
        ->where(array(
            'status'=>array('egt',1),
            'mini_appid'=>array('eq',$parmas['product']),
            $parmas['_string'],
            'user_id'=>array('exp','in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
        ))
        //->fetchSql()
        ->cache(500)
        ->field('sum(money)as new_user_pay,count(DISTINCT user_id) as new_user_pay_count')
        ->find(); //新增付费金额，新增付费人数
        
        $date=floor((time()-strtotime($parmas['start_time']))/86400);
        $data=array();
        for($i=0;$i<$date;$i++){
            $new_user_order= M('mini_game_order','','DB_CONFIG1')
            ->where(array(
                'status'=>array('egt',1),
                'mini_appid'=>array('eq',$parmas['product']),
                $parmas['_string'],
                'create_date'=>array(array('egt',strtotime($parmas['start_time'])),array('lt',strtotime($parmas['start_time'].' +'.($i+1).' day')),'and'),
                'user_id'=>array('exp','in '.M('mini_user','','DB_CONFIG1')->where($new_user_count_where)->field('mini_user_id')->buildSql())
            ))
            //->fetchSql()
            ->cache(500)
            ->field('sum(money)as new_user_pay,count(DISTINCT user_id) as new_user_pay_count')
            ->find(); //新增付费金额，新增付费人数
            $new_user_order['new_user_pay']=$new_user_order['new_user_pay']/100;
            $data['ltv']['ltv'.($i)]=$new_user_order['new_user_pay']/$new_user_count?round(($new_user_order['new_user_pay']/$new_user_count),2):'-';
        }
        $data['新增注册人数']=$new_user_count;
        $data['充值总额']=$sum_new_user_order['new_user_pay']/100?round($sum_new_user_order['new_user_pay']/100,2):'-';
        return $data;
    }

        //导出Excel表格
    public function get_baseExecl(){

         if($_GET['start_time']&&$_GET['cps']!='null'&&$_GET['game_cps']!='null'){
            $_GET['game_cps'] = json_decode($_GET['game_cps'],true);
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);
           
            foreach (array_fill(0,($date+1),$_GET['game_cps']) as $k=>$v){
                foreach ($v as $vv){
                    $page_where[]=array(
                        'channel'=>$vv,
                        'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$k.'day')),
                        'product'=>$_GET['cps']
                    );
                }
            }
                
            $count      = count($page_where);// 查询满足要求的总记录数
           
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里
            
            $data=self::base_data_core($page_where);
            $data_sum=self::base_data_sum($data);
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            self::base_execlData($data);
        }else{
            if($_GET['game_cps']=='null'){
                exit(self::error('请先选择筛选条件后，再导出Excel数据！'));
            }
        }

    }
    //导出Excel方法
    public function base_execlData($data){
        $game = M('mini_programs','','DB_CONFIG1')->where(array('mini_appid'=>$_GET['cps']))->find();
        vendor('PHPExcel.PHPExcel');
        $objPHPExcel = new \PHPExcel();
        import("Org.Util.PHPExcel");
        import("Org.Util.PHPExcel.Worksheet.Drawing");
        import("Org.Util.PHPExcel.Writer.Excel2007");
        $objActSheet = $objPHPExcel->getActiveSheet();
        $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(10);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(8);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('F')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('G')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('H')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('I')->setWidth(10);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('J')->setWidth(10);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('K')->setWidth(23);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('L')->setWidth(15);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('M')->setWidth(23);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('N')->setWidth(23);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('O')->setWidth(23);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('P')->setWidth(23);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('Q')->setWidth(28);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('R')->setWidth(28);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('S')->setWidth(28);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('T')->setWidth(28);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('U')->setWidth(28);//宽度

        $objActSheet->setCellValue('A1', '时间');
        $objActSheet->setCellValue('B1', '产品');
        $objActSheet->setCellValue('C1', '渠道');
        $objActSheet->setCellValue('D1', '新增注册');
        $objActSheet->setCellValue('E1', '新增创角');
        $objActSheet->setCellValue('F1', '创角转化率');
        $objActSheet->setCellValue('G1', '总登陆用户');
        $objActSheet->setCellValue('H1', '老用户登陆');
        $objActSheet->setCellValue('I1', '新增付费率');
        $objActSheet->setCellValue('J1', '新增付费人数');
        $objActSheet->setCellValue('K1', '新增arppu');
        $objActSheet->setCellValue('L1', '新用户付费金额');
        $objActSheet->setCellValue('M1', '老用户付费率');
        $objActSheet->setCellValue('N1', '老用户付费人数');
        $objActSheet->setCellValue('O1', '老用户arppu');
        $objActSheet->setCellValue('P1', '总付费率');
        $objActSheet->setCellValue('Q1', '总arpu');
        $objActSheet->setCellValue('R1', '总付费人数(去重)');
        $objActSheet->setCellValue('S1', '总付费金额');
        $objActSheet->setCellValue('T1', '总arppu');
        $objActSheet->setCellValue('U1', 'LTV1');

        foreach($data as $k=>$val){
            $k +=2;
            $objActSheet->setCellValue('A'.$k, $val['start_time']?$val['start_time']:$data[0]['time']);
            $objActSheet->setCellValue('B'.$k, $game['mini_name']);  
            $objActSheet->setCellValue('C'.$k, $_GET['game_cps']);  
            $objActSheet->setCellValue('D'.$k, $val['新增注册']);
            $objActSheet->setCellValue('E'.$k, $val['新增创角']); 
            $objActSheet->setCellValue('F'.$k, $val['创角转化率']);
            $objActSheet->setCellValue('G'.$k, $val['总登陆用户']); 
            $objActSheet->setCellValue('H'.$k, $val['老用户登陆']); 
            $objActSheet->setCellValue('I'.$k, $val['新增付费率']);
            $objActSheet->setCellValue('J'.$k, $val['新增付费人数']);
            $objActSheet->setCellValue('K'.$k, $val['新增arppu']); 
            $objActSheet->setCellValue('L'.$k, $val['新用户付费金额']); 
            $objActSheet->setCellValue('M'.$k, $val['老用户付费率']);
            $objActSheet->setCellValue('N'.$k, $val['老用户付费人数']);
            $objActSheet->setCellValue('O'.$k, $val['老用户arppu']);
            $objActSheet->setCellValue('P'.$k, $val['总付费率']);
            $objActSheet->setCellValue('Q'.$k, $val['总arpu']);
            $objActSheet->setCellValue('R'.$k, $val['总付费人数']);
            $objActSheet->setCellValue('S'.$k, $val['总付费金额']);
            $objActSheet->setCellValue('T'.$k, $val['总arppu']);
            $objActSheet->setCellValue('U'.$k, $val['ltv1']);
        }
        $fileName = '基础数据表';
        $date = date("Y-m-d",time());
        $fileName .= "_{$date}.xlsx";
        //将输出重定向到一个客户端web浏览器(Excel2007)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header("Content-Disposition: attachment; filename=\"$fileName\"");
        header('Cache-Control: max-age=0');
        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, "Excel2007");
        $objWriter->save('php://output');
        $objPHPExcel->disconnectWorksheets();
        unset($objPHPExcel);
        exit;
    }

    public function get_ltvExecl(){
        if($_GET['start_time']&&$_GET['cps']!='null'&&$_GET['game_cps']!='null'){
            $_GET['game_cps'] = json_decode($_GET['game_cps'],true);
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);

            foreach (array_fill(0,1,$_GET['game_cps']) as $k=>$v){
                foreach ($v as $vv){
                    $channel .= $vv.',';
                }
            }
            $channel = rtrim($channel, ',');
            foreach (array_fill(0,($date+1),$_GET['game_cps']) as $key => $value) {
                $page_where[]=array(
                    'channel'=>$channel,
                    'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$key.'day')),
                    'product'=>$_GET['cps']
                );
            }
            
            $count      = count($page_where);// 查询满足要求的总记录数
            
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里

            $data = self::ltv_data_core($page_where);
            $time = date('Y-m-d',strtotime($comma_separated[0]));
            $data_sum=self::ltv_data_sum($data,$time);
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            self::ltv_execlData($data,$channel);
        }else{
            if($_GET['game_cps']=='null'){
                exit(self::error('请先选择筛选条件后，再导出Excel数据！'));
            }
        }
    }

    //导出Excel方法[ltv]
    public function ltv_execlData($data,$channel){
        $game = M('mini_programs','','DB_CONFIG1')->where(array('mini_appid'=>$_GET['cps']))->find();
        vendor('PHPExcel.PHPExcel');
        $objPHPExcel = new \PHPExcel();
        import("Org.Util.PHPExcel");
        import("Org.Util.PHPExcel.Worksheet.Drawing");
        import("Org.Util.PHPExcel.Writer.Excel2007");
        $objActSheet = $objPHPExcel->getActiveSheet();
        $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(10);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('E')->setWidth(18);//宽度
        for ($i = 5; $i <= count($data[0]['ltv'])+4; $i++) {
            $y = ($i / 26);
            if ($y >= 1) {
                $y = intval($y);
                $objPHPExcel->getActiveSheet()->getColumnDimension(chr($y+64).chr($i-$y*26 + 65))->setWidth(8);//宽度
            } else {
                $objPHPExcel->getActiveSheet()->getColumnDimension(chr($i+65))->setWidth(8);//宽度
            }
        }
        
        $objActSheet->setCellValue('A1', '时间');
        $objActSheet->setCellValue('B1', '产品');
        $objActSheet->setCellValue('C1', '渠道');
        $objActSheet->setCellValue('D1', '新增注册人数');
        $objActSheet->setCellValue('E1', '充值总额');

        
        $k='1';
        for ($i = 5; $i <= count($data[0]['ltv'])+4; $i++) {
            $y = ($i / 26);
            if ($y >= 1) {
                $y = intval($y);
                $objActSheet->setCellValue(chr($y+64).chr($i-$y*26 + 65).'1', 'ltv'.$k);
            } else {
                $objActSheet->setCellValue(chr($i+65).'1', 'ltv'.$k);
            }
            $k++;
        }
        $ii=0;
        foreach ($data as $kk => $value) {
            $ltv[$ii] = $value['ltv'];
            $ii++;
        }
        $io=0;
        foreach($data as $k=>$val){
            $k +=2;
            $objActSheet->setCellValue('A'.$k, $val['time']);
            $objActSheet->setCellValue('B'.$k, $game['mini_name']);  
            $objActSheet->setCellValue('C'.$k, $channel);  
            $objActSheet->setCellValue('D'.$k, $val['新增注册人数']);
            $objActSheet->setCellValue('E'.$k, $val['充值总额']);

            for ($i = 5; $i <= count($val['ltv'])+4; $i++) {
                $y = ($i / 26);
                if ($y >= 1) {
                    $y = intval($y);
                    $objActSheet->setCellValue(chr($y+64).chr($i-$y*26 + 65).$k, $ltv[$io]['ltv'.($i-5)]);
                } else {
                    $objActSheet->setCellValue(chr($i+65).$k, $ltv[$io]['ltv'.($i-5)]); 
                }
            }
            $io++;
        }
        $fileName = 'ltv数据表';
        $date = date("Y-m-d",time());
        $fileName .= "_{$date}.xlsx";
        //将输出重定向到一个客户端web浏览器(Excel2007)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header("Content-Disposition: attachment; filename=\"$fileName\"");
        header('Cache-Control: max-age=0');
        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, "Excel2007");
        $objWriter->save('php://output');
        $objPHPExcel->disconnectWorksheets();
        unset($objPHPExcel);
        exit;
    }

    public function get_retainExecl(){
        if($_GET['start_time']&&$_GET['cps']!='null'&&$_GET['game_cps']!='null'){
            $comma_separated = explode(" 到 ", urldecode($_GET['start_time']));
            $_GET['game_cps'] = json_decode($_GET['game_cps'],true);
            $date=floor((strtotime($comma_separated[1])-strtotime($comma_separated[0]))/86400);

            foreach (array_fill(0,1,$_GET['game_cps']) as $k=>$v){
                foreach ($v as $vv){
                    $channel .= $vv.',';
                }
            }
            $channel = rtrim($channel, ',');
            foreach (array_fill(0,($date+1),$_GET['game_cps']) as $key => $value) {
                $page_where[]=array(
                    'channel'=>$channel,
                    'start_time'=>date('Y-m-d',strtotime($comma_separated[0].' +'.$key.'day')),
                    'product'=>$_GET['cps']
                );
            }
            
            $count      = count($page_where);// 查询满足要求的总记录数
            
            $Page       = new \Think\Page($count,15);// 实例化分页类 传入总记录数和每页显示的记录数
            $Page->lastSuffix = false;//最后一页不显示为总页数
            $Page->setConfig('header','<li class="disabled"><a>共<em>%TOTAL_ROW%</em>条  <em>%NOW_PAGE%</em>/%TOTAL_PAGE%页</a></li>');
            $Page->setConfig('prev','上一页');
            $Page->setConfig('next','下一页');
            $Page->setConfig('last','末页');
            $Page->setConfig('first','首页');
            $Page->setConfig('theme','%HEADER% %FIRST% %UP_PAGE% %LINK_PAGE% %DOWN_PAGE% %END%');
            $page_show = $Page->bootstrap_page_style($Page->show());//重点在这里
            
            $data=self::retain_data_core($page_where);
            $time = date('Y-m-d',strtotime($comma_separated[0]));
            $data_sum=self::retain_data_sum($data,$time);
            $data=array_slice($data,$Page->firstRow,$Page->listRows);
            array_unshift($data,$data_sum);
            self::retain_execlData($data,$channel);
        }else{
            if($_GET['game_cps']=='null'){
                exit(self::error('请先选择筛选条件后，再导出Excel数据！'));
            }
        }
    }

    //导出Excel方法[留存]
    public function retain_execlData($data,$channel){
        $game = M('mini_programs','','DB_CONFIG1')->where(array('mini_appid'=>$_GET['cps']))->find();
        vendor('PHPExcel.PHPExcel');
        $objPHPExcel = new \PHPExcel();
        import("Org.Util.PHPExcel");
        import("Org.Util.PHPExcel.Worksheet.Drawing");
        import("Org.Util.PHPExcel.Writer.Excel2007");
        $objActSheet = $objPHPExcel->getActiveSheet();
        $objPHPExcel->getActiveSheet()->getColumnDimension('A')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('B')->setWidth(18);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('C')->setWidth(10);//宽度
        $objPHPExcel->getActiveSheet()->getColumnDimension('D')->setWidth(18);//宽度
        for ($i = 4; $i <= count($data[0]['retain'])+2; $i++) {
            $y = ($i / 26);
            if ($y >= 1) {
                $y = intval($y);
                $objPHPExcel->getActiveSheet()->getColumnDimension(chr($y+64).chr($i-$y*26 + 65))->setWidth(8);//宽度
            } else {
                $objPHPExcel->getActiveSheet()->getColumnDimension(chr($i+65))->setWidth(8);//宽度
            }
        }
        
        $objActSheet->setCellValue('A1', '时间');
        $objActSheet->setCellValue('B1', '产品');
        $objActSheet->setCellValue('C1', '渠道');
        $objActSheet->setCellValue('D1', '用户数量');
        
        $k='2';
        for ($i = 4; $i <= count($data[0]['retain'])+2; $i++) {
            $y = ($i / 26);
            if ($y >= 1) {
                $y = intval($y);
                $objActSheet->setCellValue(chr($y+64).chr($i-$y*26 + 65).'1', $k.'日');
            } else {
                $objActSheet->setCellValue(chr($i+65).'1', $k.'日');
            }
            $k++;
        }
        $ii=0;
        foreach ($data as $kk => $value) {
            $retain[$ii] = $value['retain'];
            $ii++;
        }
        $io=0;
        foreach($data as $k=>$val){
            $k +=2;
            $objActSheet->setCellValue('A'.$k, $val['time']);
            $objActSheet->setCellValue('B'.$k, $game['mini_name']);  
            $objActSheet->setCellValue('C'.$k, $channel);  
            $objActSheet->setCellValue('D'.$k, $val['用户数量']);

            for ($i = 4; $i <= count($val['retain'])+2; $i++) {
                $y = ($i / 26);
                if ($y >= 1) {
                    $y = intval($y);
                    $objActSheet->setCellValue(chr($y+64).chr($i-$y*26 + 65).$k, $retain[$io]['retain'.($i-3)]);
                } else {
                    $objActSheet->setCellValue(chr($i+65).$k, $retain[$io]['retain'.($i-3)]); 
                }
            }
            $io++;
        }
        $fileName = '留存数据表';
        $date = date("Y-m-d",time());
        $fileName .= "_{$date}.xlsx";
        //将输出重定向到一个客户端web浏览器(Excel2007)
        header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
        header("Content-Disposition: attachment; filename=\"$fileName\"");
        header('Cache-Control: max-age=0');
        $objWriter = \PHPExcel_IOFactory::createWriter($objPHPExcel, "Excel2007");
        $objWriter->save('php://output');
        $objPHPExcel->disconnectWorksheets();
        unset($objPHPExcel);
        exit;
    }
}